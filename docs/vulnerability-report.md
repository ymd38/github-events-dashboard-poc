# Offensive Security Audit Report

**Target**: `backend/internal`
**Date**: 2026-02-17
**Scanner**: Semgrep 1.151.0 (rulesets: `auto`, `p/owasp-top-ten`, `p/golang`)
**Files Scanned**: 19 Go source files
**Methodology**: Automated SAST via Semgrep + manual expert code review

---

## Findings

---

### Finding: Weak/Hardcoded `SESSION_SECRET` in `.env`

**Location**: `.env:19`

#### Attack Path (Offensive Perspective)
- The value `your_session_secret` is a placeholder-quality string. An attacker who knows or guesses this value can craft valid gorilla/sessions cookies, sign them, and impersonate any user by setting any `user_id` value.
- If the `.env` file is accidentally committed, all GitHub OAuth credentials, the webhook secret, the token encryption key, and database passwords are exposed.

#### Risk Assessment
- **Severity**: Critical (CVSS 9.1)
- **Impact Area**: Authentication, Data Protection
- **Confidence**: High

#### Recommended Fix
- Generate a cryptographically random session secret (minimum 32 bytes, hex-encoded).
- Validate in `config.Load()` that `SESSION_SECRET` meets a minimum entropy/length requirement.
- Consider using a secrets manager (e.g., Vault, AWS Secrets Manager) instead of `.env` for production.

---

### Finding: Missing Validation of `SESSION_SECRET` Strength in Config Loading

**Location**: `internal/config/config.go:48`

#### Attack Path (Offensive Perspective)
- `SESSION_SECRET` has no validation whatsoever -- it accepts empty strings, short strings, and predictable values.
- The gorilla/sessions `CookieStore` will use any byte slice as its HMAC key, including a zero-length one.
- If `SESSION_SECRET` is empty or weak, an attacker can compute valid HMAC signatures for forged session cookies and gain access as any user.

#### Risk Assessment
- **Severity**: High (CVSS 8.1)
- **Impact Area**: Authentication / Cryptographic Failures (OWASP A02:2021)
- **Confidence**: High

#### Recommended Fix
- Add a validation check in `config.Load()` requiring `SESSION_SECRET` to be at least 32 characters.
- Reject startup if the secret appears to be a placeholder.

---

### Finding: Missing `Secure` Flag on Session Cookie (gorilla/sessions)

**Location**: `internal/auth/session.go:23-28`, `cmd/server/main.go:55-60`

#### Attack Path (Offensive Perspective)
- Attacker intercepts network traffic on an unsecured network.
- The session cookie is sent over HTTP, allowing full session hijacking.
- Attacker impersonates the victim and accesses all authenticated endpoints.

#### Risk Assessment
- **Severity**: High (CVSS 7.4)
- **Impact Area**: Authentication / Session Management
- **Confidence**: High

#### Recommended Fix
- Add `Secure: true` to the `sessions.Options` in both `internal/auth/session.go` and `cmd/server/main.go`.
- Deploy behind HTTPS and add HSTS headers.

---

### Finding: Webhook Request Body Not Size-Limited

**Location**: `internal/handler/webhook.go:36`

#### Attack Path (Offensive Perspective)
- An attacker sends a POST request to `/api/webhook` with an extremely large body.
- The body must be fully read before the HMAC signature check can occur.
- This could cause memory exhaustion (OOM) on the server.

#### Risk Assessment
- **Severity**: Medium (CVSS 5.3)
- **Impact Area**: API / Availability (DoS)
- **Confidence**: High

#### Recommended Fix
- Wrap `r.Body` with `http.MaxBytesReader(w, r.Body, maxPayloadSize)` at the start of the handler (e.g., 10MB limit).

---

### Finding: Missing `Secure` Flag on OAuth State Cookie

**Location**: `internal/auth/oauth.go:51-58`

#### Attack Path (Offensive Perspective)
- Attacker performs a network-level man-in-the-middle (e.g., on public Wi-Fi).
- If the user visits the HTTP version of the site, the `oauth_state` cookie is transmitted in plaintext.
- Attacker intercepts the state value and can mount an OAuth CSRF attack by replaying it with a malicious authorization code.

#### Risk Assessment
- **Severity**: Medium (CVSS 4.8)
- **Impact Area**: Authentication / Cookie Security
- **Confidence**: High

#### Recommended Fix
- Add `Secure: true` to the cookie definition.
- Enforce HTTPS at the infrastructure level (HSTS header, TLS termination).

---

### Finding: Missing Security Headers (HSTS, CSP, X-Frame-Options, X-Content-Type-Options)

**Location**: `internal/middleware/cors.go`

#### Attack Path (Offensive Perspective)
- **No HSTS**: Browsers will not enforce HTTPS, enabling SSL stripping attacks.
- **No X-Frame-Options**: The application can be framed in an `<iframe>` on a malicious site, enabling clickjacking.
- **No X-Content-Type-Options**: Browsers may MIME-sniff responses, potentially executing uploaded content as scripts.
- **No CSP**: No mitigation against inline script injection or XSS.

#### Risk Assessment
- **Severity**: Medium (CVSS 5.3)
- **Impact Area**: Frontend Security / Security Misconfiguration (OWASP A05:2021)
- **Confidence**: High

#### Recommended Fix
- Add a security headers middleware that sets at minimum:
  - `Strict-Transport-Security: max-age=31536000; includeSubDomains`
  - `X-Frame-Options: DENY`
  - `X-Content-Type-Options: nosniff`
  - `Content-Security-Policy: default-src 'self'`
  - `Referrer-Policy: strict-origin-when-cross-origin`

---

### Finding: SSE Endpoint Sets Wildcard CORS Origin, Bypassing Application CORS Policy

**Location**: `internal/handler/sse.go:31`

#### Attack Path (Offensive Perspective)
- An attacker hosts a malicious page that opens an `EventSource` connection to `/api/events/stream`.
- The SSE handler overrides the CORS middleware with `Access-Control-Allow-Origin: *`.
- This could break legitimate cross-origin SSE connections or leak real-time event data to any origin.

#### Risk Assessment
- **Severity**: Medium (CVSS 5.0)
- **Impact Area**: API / Cross-Origin Policy
- **Confidence**: Medium

#### Recommended Fix
- Remove the hardcoded `Access-Control-Allow-Origin: *` from the SSE handler. The CORS middleware already handles this correctly for the configured frontend origin.

---

### Finding: SSE Data Injection via Unescaped `fmt.Fprintf` to ResponseWriter

**Location**: `internal/handler/sse.go:50`

#### Attack Path (Offensive Perspective)
- An attacker creates a GitHub issue or PR with a carefully crafted title/body.
- The webhook fires, data is stored, then broadcast via SSE to all connected dashboard users.
- If the frontend renders the SSE `data` field without proper output encoding, this becomes a Stored XSS vector.
- SSE protocol injection could send fake events to all connected clients.

#### Risk Assessment
- **Severity**: Medium (CVSS 5.4)
- **Impact Area**: Frontend / SSE stream
- **Confidence**: Low

#### Recommended Fix
- Validate and sanitize all fields in `model.Event` before broadcasting.
- Explicitly ensure SSE `data` payloads cannot contain raw newline characters.
- Ensure the frontend applies contextual output encoding when rendering SSE event data.

---

### Finding: Missing Attributes on OAuth State Cookie Deletion

**Location**: `internal/auth/oauth.go:71-76`

#### Attack Path (Offensive Perspective)
- Without `Secure`, the clear instruction might not match the original `Secure` cookie in some browsers, leaving the state cookie active.
- While the impact is limited (the cookie value is empty), it represents a defense-in-depth gap.

#### Risk Assessment
- **Severity**: Low (CVSS 2.4)
- **Impact Area**: Cookie Security
- **Confidence**: Medium

#### Recommended Fix
- Set `Secure: true`, `HttpOnly: true`, and `SameSite: http.SameSiteLaxMode` on the deletion cookie to match the attributes of the original cookie exactly.

---

### Finding: Duplicate Session Store Instantiation with Potentially Divergent Configuration

**Location**: `cmd/server/main.go:52-60`

#### Attack Path (Offensive Perspective)
- Two separate `CookieStore` instances are created with the same secret but used for different purposes.
- If one store's options diverge, sessions created by one may not be correctly validated by the other.

#### Risk Assessment
- **Severity**: Low (CVSS 3.1)
- **Impact Area**: Authentication / Security Misconfiguration
- **Confidence**: Medium

#### Recommended Fix
- Use a single shared `sessions.CookieStore` instance across the application.

---

### Finding: Internal Error Details Leaked to Webhook Callers

**Location**: `internal/handler/webhook.go:67`

#### Attack Path (Offensive Perspective)
- An attacker sends crafted webhook payloads to trigger various error conditions.
- Error messages reveal internal implementation details (database schema, library versions, etc.).
- This information aids further attacks (SQL injection reconnaissance, etc.).

#### Risk Assessment
- **Severity**: Low (CVSS 3.7)
- **Impact Area**: API / Information Disclosure (OWASP A04:2021)
- **Confidence**: Medium

#### Recommended Fix
- Return a generic error message to the client (e.g., "failed to process webhook").
- Log the detailed error internally only.

---

### Finding: Stack Trace Logged in Recovery Middleware

**Location**: `internal/middleware/recovery.go:13-16`

#### Attack Path (Offensive Perspective)
- Full stack traces are logged on panic recovery.
- If logs are sent to an aggregation service with insufficient access controls, this could expose internal source code paths, function names, and Go runtime internals.

#### Risk Assessment
- **Severity**: Low (CVSS 2.1)
- **Impact Area**: Data Protection / Logging
- **Confidence**: Low

#### Recommended Fix
- Ensure log aggregation systems have proper access controls.
- Consider truncating stack traces in production environments.

---

## Semgrep Findings Triage

| Semgrep Finding | Verdict | Rationale |
|---|---|---|
| `no-fprintf-to-responsewriter` on SSE handler | **Partially True** | Data is JSON-marshaled so literal XSS is unlikely, but SSE protocol injection remains a concern. |
| `cookie-missing-secure` on OAuth state cookie | **True** | Confirmed missing `Secure` attribute. |
| `cookie-missing-httponly` on cookie deletion | **True** | Confirmed missing `HttpOnly` attribute on deletion cookie. |
| `session-cookie-missing-secure` on gorilla/sessions | **True** | Confirmed missing `Secure` attribute on session cookie. |

---

## Summary

| # | Finding | Severity | Location | Status |
|---|---------|----------|----------|--------|
| 1 | Weak/Hardcoded `SESSION_SECRET` | **Critical** | `.env:19` | True Vulnerability |
| 2 | No Validation of `SESSION_SECRET` Strength | **High** | `internal/config/config.go:48` | True Vulnerability |
| 3 | Missing `Secure` Flag on Session Cookie | **High** | `internal/auth/session.go:23-28` | True Vulnerability |
| 4 | Webhook Request Body Not Size-Limited | Medium | `internal/handler/webhook.go:36` | True Vulnerability |
| 5 | Missing `Secure` Flag on OAuth State Cookie | Medium | `internal/auth/oauth.go:51-58` | True Vulnerability |
| 6 | Missing Security Headers | Medium | `internal/middleware/cors.go` | True Vulnerability |
| 7 | Wildcard CORS on SSE Endpoint | Medium | `internal/handler/sse.go:31` | True Vulnerability |
| 8 | SSE Data Injection via `fmt.Fprintf` | Medium | `internal/handler/sse.go:50` | True Vulnerability |
| 9 | Missing Attributes on Cookie Deletion | Low | `internal/auth/oauth.go:71-76` | True Vulnerability |
| 10 | Duplicate Session Store Instances | Low | `cmd/server/main.go:52-60` | True Vulnerability |
| 11 | Internal Error Details Leaked | Low | `internal/handler/webhook.go:67` | True Vulnerability |
| 12 | Stack Traces in Logs | Low | `internal/middleware/recovery.go:13-16` | True Vulnerability |

**Total True Vulnerabilities: 12**
**Total False Positives: 0**

| Severity | Count |
|----------|-------|
| Critical | 1 |
| High | 2 |
| Medium | 5 |
| Low | 4 |
