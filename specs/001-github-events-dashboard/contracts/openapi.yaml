openapi: 3.0.3
info:
  title: GitHub Events Dashboard API
  description: |
    GitHubリポジトリのイベントをWebhookで受信し、ダッシュボードでリアルタイム表示するサービスのAPI仕様。
    バックエンド (Go) が提供するREST APIエンドポイントを定義する。
  version: 1.0.0
  contact:
    name: GitHub Events Dashboard PoC

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: webhook
    description: GitHub Webhook受信エンドポイント
  - name: events
    description: イベント一覧・詳細取得API
  - name: auth
    description: GitHub OAuth認証
  - name: sse
    description: Server-Sent Events (リアルタイム配信)
  - name: health
    description: ヘルスチェック

paths:
  /api/webhook:
    post:
      tags: [webhook]
      summary: GitHub Webhookイベント受信
      description: |
        GitHubからのWebhookイベントを受信する。
        X-Hub-Signature-256ヘッダーによる署名検証を行い、
        検証成功時のみイベントをDBに保存しSSEで配信する。
        認証不要（GitHub側からの呼び出し）。
      operationId: receiveWebhook
      parameters:
        - name: X-Hub-Signature-256
          in: header
          required: true
          schema:
            type: string
          description: HMAC-SHA256署名
        - name: X-GitHub-Delivery
          in: header
          required: true
          schema:
            type: string
            format: uuid
          description: GitHub delivery ID（冪等性キー）
        - name: X-GitHub-Event
          in: header
          required: true
          schema:
            type: string
            enum: [issues, pull_request]
          description: イベント種別
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: GitHub Webhookペイロード（イベント種別により構造が異なる）
      responses:
        "200":
          description: イベント受信成功（重複の場合も200を返す）
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponse"
        "400":
          description: 不正なリクエスト（ペイロードパースエラー等）
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: 署名検証失敗
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/events:
    get:
      tags: [events]
      summary: イベント一覧取得
      description: |
        保存済みイベントをページネーション付きで新しい順に取得する。
        イベント種別によるフィルタリングが可能。
      operationId: listEvents
      security:
        - sessionCookie: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: ページ番号
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: 1ページあたりの件数
        - name: event_type
          in: query
          schema:
            type: string
            enum: [issues, pull_request]
          description: イベント種別フィルタ
      responses:
        "200":
          description: イベント一覧
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventListResponse"
        "401":
          description: 未認証
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/events/{id}:
    get:
      tags: [events]
      summary: イベント詳細取得
      description: 指定IDのイベント詳細情報を取得する。
      operationId: getEvent
      security:
        - sessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: イベントID
      responses:
        "200":
          description: イベント詳細
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "401":
          description: 未認証
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: イベントが見つからない
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/login:
    get:
      tags: [auth]
      summary: GitHub OAuthログイン開始
      description: GitHub OAuth認可画面にリダイレクトする。
      operationId: login
      responses:
        "302":
          description: GitHub認可画面へリダイレクト
          headers:
            Location:
              schema:
                type: string
              description: GitHub OAuth認可URL

  /api/auth/callback:
    get:
      tags: [auth]
      summary: GitHub OAuthコールバック
      description: |
        GitHubからのOAuthコールバックを処理する。
        アクセストークンを取得し、ユーザー情報を保存してセッションを作成する。
      operationId: authCallback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: GitHub認可コード
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: CSRF防止用state値
      responses:
        "302":
          description: ダッシュボードへリダイレクト（セッションCookie付与）
          headers:
            Location:
              schema:
                type: string
              description: フロントエンドURL
            Set-Cookie:
              schema:
                type: string
              description: セッションCookie
        "400":
          description: 認証失敗（認可コード不正、ユーザー拒否等）
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/auth/logout:
    post:
      tags: [auth]
      summary: ログアウト
      description: セッションを破棄しログアウトする。
      operationId: logout
      security:
        - sessionCookie: []
      responses:
        "200":
          description: ログアウト成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"

  /api/auth/me:
    get:
      tags: [auth]
      summary: 現在のユーザー情報取得
      description: セッションに紐づくユーザー情報を返す。
      operationId: getCurrentUser
      security:
        - sessionCookie: []
      responses:
        "200":
          description: ユーザー情報
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: 未認証
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/events/stream:
    get:
      tags: [sse]
      summary: SSEイベントストリーム
      description: |
        Server-Sent Eventsでリアルタイムにイベントを配信する。
        新しいイベントが受信されるたびにクライアントへプッシュする。
        セッション認証が必要。セッション期限切れ時は接続を切断する。
      operationId: streamEvents
      security:
        - sessionCookie: []
      responses:
        "200":
          description: SSEストリーム
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSEフォーマット:
                  event: new_event
                  data: {"id":1,"event_type":"issues","action":"opened",...}

                  event: session_expired
                  data: {"message":"Session expired"}
        "401":
          description: 未認証
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/health:
    get:
      tags: [health]
      summary: ヘルスチェック
      description: バックエンドサービスとDB接続の稼働状況を返す。
      operationId: healthCheck
      responses:
        "200":
          description: 正常稼働
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "503":
          description: サービス異常（DB接続失敗等）
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id
      description: GitHub OAuth認証後に発行されるセッションCookie

  schemas:
    Event:
      type: object
      required:
        - id
        - delivery_id
        - event_type
        - action
        - repo_name
        - sender_login
        - html_url
        - occurred_at
        - received_at
      properties:
        id:
          type: integer
          format: int64
          description: イベントID
        delivery_id:
          type: string
          format: uuid
          description: GitHub delivery ID
        event_type:
          type: string
          enum: [issues, pull_request]
          description: イベント種別
        action:
          type: string
          description: アクション (opened, closed等)
        repo_name:
          type: string
          description: リポジトリ名 (owner/repo)
        sender_login:
          type: string
          description: 操作者のGitHubユーザー名
        sender_avatar_url:
          type: string
          nullable: true
          description: 操作者のアバターURL
        title:
          type: string
          nullable: true
          description: Issue/PRのタイトル
        body:
          type: string
          nullable: true
          description: Issue/PRの本文（先頭500文字）
        html_url:
          type: string
          format: uri
          description: GitHubの該当ページURL
        event_data:
          type: object
          nullable: true
          description: イベント固有の追加データ
        occurred_at:
          type: string
          format: date-time
          description: イベント発生日時
        received_at:
          type: string
          format: date-time
          description: システム受信日時

    EventListResponse:
      type: object
      required:
        - events
        - pagination
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/Event"
        pagination:
          $ref: "#/components/schemas/Pagination"

    Pagination:
      type: object
      required:
        - page
        - per_page
        - total
        - total_pages
      properties:
        page:
          type: integer
          description: 現在のページ番号
        per_page:
          type: integer
          description: 1ページあたりの件数
        total:
          type: integer
          description: 総件数
        total_pages:
          type: integer
          description: 総ページ数

    User:
      type: object
      required:
        - id
        - login
        - display_name
      properties:
        id:
          type: integer
          format: int64
          description: ユーザーID
        login:
          type: string
          description: GitHubユーザー名
        display_name:
          type: string
          description: 表示名
        avatar_url:
          type: string
          nullable: true
          description: アバターURL

    WebhookResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [received, duplicate]
          description: 受信ステータス
        event_id:
          type: integer
          format: int64
          nullable: true
          description: 保存されたイベントID（duplicateの場合はnull）

    HealthResponse:
      type: object
      required:
        - status
        - checks
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: 全体ステータス
        checks:
          type: object
          properties:
            database:
              type: string
              enum: [up, down]
              description: DB接続状態

    MessageResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: メッセージ

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: エラーメッセージ
        code:
          type: string
          description: エラーコード
